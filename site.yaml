---
- hosts: localhost
  connection: local
  become: true
  name: Setup to build packages
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python3
    key: "{{ lookup('fileglob', '*.rsa') }}"
    mirror: http://dl-cdn.alpinelinux.org/alpine
    packages:
      alpine-sdk: for the abuild commmand
      lua-aports: for the buildrepo command
      tree: to create index.html
  tasks:
    - name: Check that a private key is available
      assert: { that: "{{ key|join('') is file }}" }
      when: lookup('file', '/proc/1/cgroup') is search('docker|lxc')
    - name: Install the public key so `apk index` succeeds
      copy:
        src: packages/{{ key | basename }}.pub
        dest: /etc/apk/keys/{{ key | basename }}.pub
    - name: Make repositories available for dependencies
      copy:
        dest: /etc/apk/repositories
        content: |
          {{ mirror }}/edge/main
          {{ mirror }}/edge/community
          {{ mirror }}/edge/testing
      notify: [Fetch repository indexes]
    - meta: flush_handlers
    - { name: Install packages, apk: { name: "{{ packages.keys() | list }}" } }
    - name: /etc/abuild.conf points to private key
      lineinfile:
        path: /etc/abuild.conf
        create: yes
        line: PACKAGER_PRIVKEY='{{ key }}'
  handlers:
    - name: Fetch repository indexes
      apk: { update_cache: yes }
# vim: ft=yaml.ansible
